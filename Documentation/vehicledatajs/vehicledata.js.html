<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: vehicledata.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: vehicledata.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var express =require('express');
var router = express.Router();

var index = require('./index');
var db = require('./db');
/** delivers the page for addition of vehicle data
*@typedef vehicledata
*/
router.get('/', function (req, res){
	if(req.session.user){
		res.sendFile('/templates/vehicle/vehicle_data.html', {root: __dirname});
	}else{
		res.redirect('/'); 
	}
});
/** deals with the vehicledata request and check validation and if passed then stores in database.
*@typedef vehicledata
*/
router.post('/', index.urlencodedparser, function (req, res){
	req.assert('deviceid', "deviceid field cannot be empty").notEmpty();
	req.assert('latitude', "latitude field cannot be empty").notEmpty();
	req.assert('longitude', "longitude field cannot be empty").notEmpty();
	
	var errors = req.validationErrors();
	if(errors){
		var error_list = [];
		for(error in errors){
			console.log(errors[error].msg);
			error_list.push(errors[error].msg);
		}
		console.log(error_list);
		
	}else{
		var d = new Date();
		var sdd = d.toISOString();
		var sdt = d.toString();
		var date = sdd.substring(0,10).replace(/-/gi,'');
		var time = sdt.substring(16,24).replace(/:/gi,'');
		console.log(date);
		console.log(time);
		var deviceid = req.body.deviceid;
		var latitude = req.body.latitude;
		var longitude = req.body.longitude;
		var fuel = req.body.fuel;
		if(!fuel){
			fuel=null;
		}
		var speed = req.body.speed;
		if(!speed){
			speed=null;
		}
		
		db.select('SELECT device_id.id FROM device_id INNER JOIN company_detail ON '+
			'device_id.company_id=company_detail.id WHERE company_detail.username=$1 '+
			'AND device_id.device_id=$2', [req.session.user, deviceid], function (err, result){
				if(err){

				}else{
					var device_id = result[0].id;
					db.insert('INSERT INTO vehicle_data(latitude,longitude,date,time,fuel,speed,device_id) '+
								'VALUES ($1,$2,$3,$4,$5,$6,$7)',[latitude,longitude,date,time,fuel,speed,device_id]);
					res.redirect('/vehicledata');
				}
		});
	}
});


module.exports = router;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Dec 18 2015 11:04:04 GMT+0545 (NPT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
